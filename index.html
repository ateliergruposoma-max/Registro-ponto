<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Registro de Ponto</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                primary: "#135bec",
                "background-light": "#f6f6f8"
            }
        }
    }
}
</script>

<style>
body {
    font-family: Arial, sans-serif;
}
</style>
</head>

<body class="bg-background-light min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 space-y-4">

    <h2 class="text-2xl font-semibold text-center text-primary">
        Registro de Ponto
    </h2>

    <!-- Nome -->
    <div class="relative">
        <label class="block text-sm font-medium mb-1">
            Nome <span class="text-red-500">*</span>
        </label>
        <input
            id="nome"
            type="text"
            placeholder="Carregando nomes..."
            class="w-full rounded-lg border px-4 py-3 focus:ring-2 focus:ring-primary"
            autocomplete="off"
            disabled
        />
        <ul
            id="listaNomes"
            class="absolute z-10 w-full border rounded-lg mt-1 max-h-40 overflow-y-auto hidden bg-white"
        ></ul>
    </div>

    <!-- Entrada (opcional) -->
    <div>
        <label class="block text-sm font-medium mb-1">Entrada</label>
        <input id="entrada" type="time" class="w-full rounded-lg border px-4 py-3" />
    </div>

    <!-- Saída -->
    <div>
        <label class="block text-sm font-medium mb-1">
            Saída <span class="text-red-500">*</span>
        </label>
        <input id="saida" type="time" class="w-full rounded-lg border px-4 py-3" />
    </div>

    <!-- Data -->
    <div>
        <label class="block text-sm font-medium mb-1">
            Data <span class="text-red-500">*</span>
        </label>
        <input id="data" type="date" class="w-full rounded-lg border px-4 py-3" />
    </div>

    <!-- Foto -->
    <div>
        <label class="block text-sm font-medium mb-1">
            Foto <span class="text-red-500">*</span>
        </label>
        <input id="foto" type="file" accept="image/*" />
        <img id="previewImagem" class="hidden mt-3 rounded-lg max-h-48 mx-auto"/>
    </div>

    <button
        onclick="enviar()"
        class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:opacity-90"
    >
        Enviar Registro
    </button>

    <p id="msgError" class="hidden text-center text-red-500"></p>
    <p id="msgSuccess" class="hidden text-center text-green-600">
        Registro enviado com sucesso!
    </p>

</div>

<script>
const URL_GET_NOMES  = "https://labsazzas2154.app.n8n.cloud/webhook/nomes";
const URL_POST_PONTO = "https://labsazzas2154.app.n8n.cloud/webhook/ponto";

let cadastro = [];
let fotoBase64 = null;
let nomeSelecionado = false;
let carregandoNomes = true;

// ELEMENTOS
const inputNome = document.getElementById("nome");
const inputEntrada = document.getElementById("entrada");
const inputSaida = document.getElementById("saida");
const inputData = document.getElementById("data");
const inputFoto = document.getElementById("foto");
const lista = document.getElementById("listaNomes");
const msgError = document.getElementById("msgError");
const msgSuccess = document.getElementById("msgSuccess");
const previewImagem = document.getElementById("previewImagem");

// ---------- CARREGAR NOMES ----------
async function carregarCadastro() {
    try {
        carregandoNomes = true;
        inputNome.disabled = true;
        inputNome.placeholder = "Carregando nomes...";

        const res = await fetch(URL_GET_NOMES);
        cadastro = await res.json();

        carregandoNomes = false;
        inputNome.disabled = false;
        inputNome.placeholder = "Digite para buscar seu nome";

    } catch (e) {
        carregandoNomes = false;
        inputNome.placeholder = "Erro ao carregar nomes";
        console.error("Erro ao buscar nomes", e);
    }
}

// ---------- AUTOCOMPLETE ----------
function renderLista(valor = "") {
    lista.innerHTML = "";

    const filtrados = cadastro
        .filter(p => {
            if (!p.Nome) return false;
            const nome = p.Nome.trim();
            if (nome === "" || nome === "0" || nome === "--USUÁRIO NÃO ENCONTRADO") return false;
            return nome.toLowerCase().includes(valor.toLowerCase());
        })
        .sort((a, b) => a.Nome.localeCompare(b.Nome, "pt-BR"))
        .slice(0, 15);

    filtrados.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.Nome;
        li.className = "px-4 py-2 cursor-pointer hover:bg-primary hover:text-white";
        li.onclick = () => {
            inputNome.value = p.Nome;
            nomeSelecionado = true;
            lista.classList.add("hidden");
        };
        lista.appendChild(li);
    });

    lista.classList.toggle("hidden", filtrados.length === 0);
}

inputNome.addEventListener("focus", () => {
    if (carregandoNomes) return;
    nomeSelecionado = false;
    renderLista();
});

inputNome.addEventListener("input", () => {
    if (carregandoNomes) return;
    nomeSelecionado = false;
    renderLista(inputNome.value);
});

inputNome.addEventListener("blur", () => {
    setTimeout(() => {
        if (!nomeSelecionado) inputNome.value = "";
    }, 150);
});

document.addEventListener("click", e => {
    if (!e.target.closest(".relative")) lista.classList.add("hidden");
});

// ---------- FOTO ----------
inputFoto.addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        fotoBase64 = e.target.result.split(",")[1];
        previewImagem.src = e.target.result;
        previewImagem.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
});

// ---------- ENVIAR ----------
async function enviar() {
    msgError.classList.add("hidden");
    msgSuccess.classList.add("hidden");

    if (!inputNome.value || !nomeSelecionado || !inputSaida.value || !inputData.value || !fotoBase64) {
        msgError.textContent = "Preencha todos os campos obrigatórios.";
        msgError.classList.remove("hidden");
        return;
    }

    try {
        const res = await fetch(URL_POST_PONTO, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                nome: inputNome.value,
                entrada: inputEntrada.value || null,
                saida: inputSaida.value,
                data: inputData.value,
                foto: fotoBase64
            })
        });

        if (!res.ok) throw new Error("Erro no envio");

        msgSuccess.classList.remove("hidden");

        // LIMPAR CAMPOS
        inputNome.value = "";
        inputEntrada.value = "";
        inputSaida.value = "";
        inputData.value = "";
        inputFoto.value = "";
        fotoBase64 = null;
        nomeSelecionado = false;
        previewImagem.src = "";
        previewImagem.classList.add("hidden");

    } catch (err) {
        msgError.textContent = "Não foi possível enviar o registro. Tente novamente.";
        msgError.classList.remove("hidden");
        console.error(err);
    }
}

// ---------- INICIAR ----------
window.onload = carregarCadastro;
</script>

</body>
</html>
